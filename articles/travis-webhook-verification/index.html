<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Verify Travis CI Webhook Notifications with Node.js - truveris.github.io</title>
        <meta name="description" content="Verify Travis CI Webhook Notifications with Node.js">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Favicon -->
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

        <!-- Stylesheets -->
        <link href='//fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Lora:400italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="/lib/css/style.css">

        <!-- RSS -->
        <link rel="alternate" type="application/atom+xml" href="/atom.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml">

        <!-- JS -->
        <script type="text/javascript" src="https://ws.sharethis.com/button/buttons.js"></script>
        <script type="text/javascript">stLight.options({publisher: "ur-bd6ecc7d-a28e-7a33-9fa5-a9f85b7af5fe", doNotHash: false, doNotCopy: true, hashAddressBar: false});</script>

        <!-- Social -->
        <link href="https://plus.google.com/+Truverisprescriptions" rel="publisher">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@truveris">
        <meta name="twitter:title" content="Verify Travis CI Webhook Notifications with Node.js - truveris.github.io">
        <meta name="twitter:description" content="Verify Travis CI Webhook Notifications with Node.js">
        <meta name="twitter:creator" content="@truveris">
        <meta name="twitter:domain" content="truveris.github.io">
        <meta name="twitter:image:src" content="/lib/img/server.svg">

        <meta property="og:title" content="Verify Travis CI Webhook Notifications with Node.js - truveris.github.io">
        <meta property="og:description" content="Verify Travis CI Webhook Notifications with Node.js">
        <meta property="og:url" content="https://truveris.github.io/">
        <meta property="og:site_name" content="truveris.github.io">
        <meta property="og:type" content="blog">
        <meta property="og:image" content="/lib/img/server.svg">

        <!-- SEO -->
        

        <!-- Force https -->
        <script type="text/javascript">
            var host = "truveris.github.io";
            if ((host == window.location.host) && (window.location.protocol != "https:"))
                window.location.protocol = "https";
        </script>
    </head>

    <body itemscope itemtype="http://schema.org/WebPage">
                <header class="header clearfix headroom headroom--top" id="header" role="banner">

            <a href="/">
                <span class="logo-dark-gray">truveris</span><span class="logo-light-gray">.github.io</span>
            </a>

            <a href="/jobs/" class="cta" role="link">
                We are hiring <span class="icon-right-open-mini"></span>
            </a>

        </header>

        






<article itemtype="http://schema.org/BlogPosting" itemscope class="main hentry entry" role="main">

    <!-- Article header -->
    <header>
        <figure>
            <img src="/lib/img/server.svg" alt="Verify Travis CI Webhook Notifications with Node.js" class="roundimg">
        </figure>

        <h1 itemprop="name headline" role="heading">Verify Travis CI Webhook Notifications with Node.js</h1>
    </header>

    <!-- Article content -->
    <div itemprop="description articleBody" class="entry-content">
        

<p>
    Travis CI allows users to configure <a href="https://docs.travis-ci.com/user/notifications/#Configuring-webhook-notifications">webhook notifications</a>
    which can be sent during certain build events.
    I recently played with this feature in order to send SMS messages via <a href="https://www.twilio.com/">Twilio</a> whenever a project failed to build/test.
    This post will discuss how to validate these webhook notifications to ensure that they are actually being sent by Travis CI.
</p>

<h2 role="heading">The Problem</h2>
<p>

    The app I built was able to handle incoming requests from Travis CI,
    but it had no way of checking where these requests were coming from. This meant that anyone could send a request to the app pretending to be Travis CI.
    <br>
    <br>
    The Travis CI's docs have a section on <a href="https://docs.travis-ci.com/user/notifications/#Verifying-Webhook-requests">verifying webhook requests</a>, 
    but the instructions (shown below) were a bit unclear for someone without a lot of knowledge in encryption/encoding. 
    <br>
    <br>
    1. Pick up the payload data from the HTTP request’s body.
    <br>
    2. Obtain the Signature header value, and base64-decode it.
    <br>
    3. Obtain the public key corresponding to the private key that signed the payload. 
    This is available at the /config endpoint’s config.notifications.webhook.public_key on the relevant API server. (e.g., https://api.travis-ci.org/config)
    <br>
    4. Verify the signature using the public key and SHA1 digest.
    <br>
    <br>
    The docs even give a few <a href="https://docs.travis-ci.com/user/notifications/#Examples">examples</a> on how to do this but none of 
    them pertain to JavaScript. I decided to figure it out for myself, and it ended up being pretty simple.
</p>

<h2 role="heading">The Solution</h2>

<p>
  There are many popular Node.js web frameworks and they each handle incoming requests in different ways. 
  This post will provide solutions with two of the most popular frameworks, <a href="https://expressjs.com/">Express</a> (v4.15.3) 
  and <a href="https://hapijs.com/">hapi</a> (v16.5.0). The logic can easily be ported to work with any framework.
  <br>
  <br>
  Both solutions will use the <a href="https://github.com/sindresorhus/got">got</a> library to obtain Travis's public encryption key as well as 
  the built-in <a href="https://nodejs.org/dist/latest-v6.x/docs/api/crypto.html">crypto</a> library for SHA-1 verification. 
  The Express solution will also require the <a href="https://github.com/expressjs/body-parser">body-parser</a> middleware.
  <br>
  <br>
  Note: The Node.js version being used at the time of this writing is v6.11.1 LTS.
</p>

<h3>Using Express</h3>
<p>
  Boilerplate Express code for creating a server can be found <a href="https://expressjs.com/en/starter/hello-world.html">here</a> or 
  you can reference <a href="https://github.com/Brodan/travis-webhook-verification-nodejs/blob/master/express.js">this</a> sample app. 
  The route should look as such:
  <pre><code class="language-javascript">
    /* Imports and server config go here... */

    app.post('/travis', function (req, res) {
      let travisSignature = Buffer.from(req.headers.signature, 'base64');
      let payload = req.body.payload;
      let status = false;

      got('https://api.travis-ci.org/config', {
          timeout: 10000
      })
      .then(response => {
        let travisPublicKey =
          JSON.parse(response.body).config.notifications.webhook.public_key;
        let verifier = crypto.createVerify('sha1');
        verifier.update(payload);
        status = verifier.verify(travisPublicKey, travisSignature);
      })
      .catch(error => {
        console.log('Something went wrong:\n' + error)
      })
      .then(() => {
        if (status) {
          // Handle request here now that it has been verified...
        }
        res.sendStatus(200);
      });
    });
  </code></pre>
</p>

<h3>Using hapi</h3>
<p>
  Boilerplate hapi code for creating a server can be found <a href="https://hapijs.com/tutorials#creating-a-server">here</a> or 
  you can reference <a href="https://github.com/Brodan/travis-webhook-verification-nodejs/blob/master/hapi.js">this</a> sample app. 
  The route should look as such:
  <pre><code class="language-javascript">
    /* Imports and server config go here... */

    server.route({
      method: 'POST',
      path:'/travis',
      handler: function (request, reply) {
        let travisSignature = Buffer.from(request.headers.signature, 'base64');
        let payload = request.payload.payload;
        let status = false;
        
        got('https://api.travis-ci.org/config', {
          timeout: 10000
        })
        .then(response => {
          let travisPublicKey = JSON.parse(response.body).config.notifications.webhook.public_key;
          let verifier = crypto.createVerify('sha1');
          verifier.update(payload);
          status = verifier.verify(travisPublicKey, travisSignature);
        })
        .catch(error => {
          console.log('Something went wrong:\n' + error)
        })
        .then(() => {
          if (status) {
            // Handle request here now that it has been verified...
          }
          reply(200);
        });
      }
    });
  </code></pre>

  Ensure that the correct URL is being passed into the got request, as the .org and .com domains have different public encryption keys! 
  These URLs are https://api.travis-ci.org/config and https://api.travis-ci.com/config, respectively.
</p>

<h2 role="heading">Wrapping Up</h2>

<p>
    The full source code for both the hapi and Express apps above can be found in 
    <a href="https://github.com/Brodan/travis-webhook-verification-nodejs">this</a> Github repository.
    <br>
    <br>
    Additional thanks to <a href="https://wycd.net/">Wayne Chang</a> for helping me proofread and improve this post.
</p>

        <div class="large-separator" role="separator"></div>
    </div>

    <!-- Article footer -->
    <footer class="post-footer clearfix">

            <div class="post-social">
                <span class='st_twitter_hcount' displayText='Tweet' st_via="truveris"></span>
                <span class='st_linkedin_hcount' displayText='LinkedIn'></span>
            </div>

            <div class="byline vcard">
                <meta content="https://truveris.github.io//articles/travis-webhook-verification/" itemprop="url">

                <a href="https://github.com/brodan">
                    <img src="/lib/img/helmet.svg" alt="Chris Hranj profil pic" class="profil_pic">
                </a>

                <span class="fn author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
                    <a href="https://github.com/brodan" class="url"><span itemprop="name">Chris Hranj</span></a>
                </span>
                <br />
                <time datetime="2017-10-01T20:00:00" itemprop="datePublished" class="date published updated">October 01, 2017</time>
                <br />

                <span class="org">Truveris</span>
                <div class="adr">
                    <span class="locality">New York</span>
                    <span class="country-name">USA</span>
                </div>
            </div>

    </footer>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'truveris'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</article>

<p class="mobile-cta">
	<a href="/jobs/" class="cta" role="link">
		We are hiring <span class="icon-right-open-mini"></span>
	</a>
</p>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/lib/js/min/core-min.js"></script>
<script src="/lib/js/plugins/lightbox.js"></script>
<script>
    $(document).ready(function() {
        $('.image-link').magnificPopup({
            type: 'image',
            mainClass: 'mfp-with-zoom',
            closeOnContentClick: true,

            zoom: {
                enabled: true,
                duration: 300,
                easing: 'ease-in-out',
                opener: function(openerElement) {
                    return openerElement.is('img') ? openerElement : openerElement.find('img');
                }
            }
        });
    });
</script>


                <footer class="footer clearfix" role="contentinfo">

            <div class="wrap">

                <p class="social">
                    <a href="https://github.com/truveris/" data-tooltip="Github"><span class="icon-github"></span></a>
                    <a href="https://twitter.com/truveris" data-tooltip="Twitter"><span class="icon-twitter"></span></a>
                    <a href="https://www.linkedin.com/company/truveris" data-tooltip="Linkedin"><span class="icon-linkedin"></span></a>
                </p>

                <p class="copyright">
                    <span class="company" itemprop="copyrightHolder sourceOrganization">
						<a href="http://truveris.com" target="_blank"><img src="/lib/img/truveris-logo.png"/></a>
					</span> ⓒ
                    <span itemprop="copyrightYear">2015-2017</span>.
                    <span class="rightsreserved">All Rights Reserved.</span>
                </p>

            </div>
        </footer>

        <script src="/lib/js/min/core-min.js"></script>

        <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-31708065-8', 'auto');
      ga('send', 'pageview');
    </script>

    </body>

</html>





